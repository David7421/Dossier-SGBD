create or replace TRIGGER COPIECOTESAVIS
BEFORE INSERT OR UPDATE ON EVALUATION
FOR EACH ROW
DECLARE
  checkException exception;
  pragma exception_init(checkException, -2291);
BEGIN
	IF :NEW.TOKEN IS NULL THEN
		:NEW.TOKEN := 'OK';
		LOGEVENT('CB : TRIGGER COPIECOTESAVIS', 'Debut de copie');

			IF (INSERTING) THEN
				INSERT INTO EVALUATION@CBB.DBL (IDFILM, LOGIN, COTE, AVIS, DATEEVAL, TOKEN)
				VALUES (:NEW.IDFILM, :NEW.LOGIN, :NEW.COTE, :NEW.AVIS, :NEW.DATEEVAL, :NEW.TOKEN);
			END IF;

			IF (UPDATING) THEN
				UPDATE EVALUATION@CBB.DBL
				SET	COTE = :NEW.COTE,
					AVIS = :NEW.AVIS,
					DATEEVAL = :NEW.DATEEVAL,
					TOKEN = :NEW.TOKEN
				WHERE	IDFILM = :NEW.IDFILM AND LOGIN = :NEW.LOGIN;
			END IF;

		LOGEVENT('CB : TRIGGER COPIECOTESAVIS', 'Copie reussie');
	END IF;

EXCEPTION
  	WHEN checkException THEN :NEW.TOKEN := 'KO'; LOGEVENT('CB : TRIGGER COPIECOTESAVIS', 'Copie ratee (Foreign Key) => ' || SQLCODE || ' : ' || SQLERRM);
	WHEN OTHERS THEN LOGEVENT('CB : TRIGGER COPIECOTESAVIS', 'Copie ratee => ' || SQLCODE || ' : ' || SQLERRM); RAISE;
END;
/

COMMIT;